# ECharts Convert 插件 - 产品需求文档 (PRD)

## 1. 产品概述

### 1.1 功能定位
ECharts Convert 是一个 Dify 插件工具，用于将文本内容中的 ECharts 配置代码块自动转换为图片。插件能够识别 Markdown 格式的 ````echarts` 代码块，解析其中的 JSON 配置，渲染为 SVG 图片，并将原代码块替换为图片。

### 1.2 使用场景

- **报告生成**：批量处理包含多个图表的文档，统一转换为图片格式，便于导出为docx/pdf等格式

## 2. 功能需求

### 2.1 核心功能

#### 2.1.1 代码块识别与解析
- 从输入文本中识别 ````echarts` 格式的代码块
- 解析代码块内的 JSON 配置
- 支持多个代码块批量处理
- 对无效的 JSON 配置提供错误提示

#### 2.1.2 图表渲染
- 将 ECharts JSON 配置渲染为 SVG 图片
- 支持自定义图片尺寸（宽度、高度）
- 支持配置合并（通过 mergeEchartsOptions 参数）
- 支持并发渲染多个图表（1-4 个 worker）

#### 2.1.3 文本替换
- 将成功渲染的代码块替换为 Markdown 图片语法
- 保留原文本的其他内容不变
- 失败的代码块保持原样，不进行替换

#### 2.1.4 结果输出
- 返回更新后的文本内容（包含图片引用）
- 返回渲染的图片文件（blob 格式）
- 返回处理摘要（成功/失败数量、使用的并发数等）

### 2.2 参数配置

#### 2.2.1 必需参数
- **content** (string): 包含 ````echarts` 代码块的文本内容

#### 2.2.2 可选参数
- **width** (number, 默认 800): 图表宽度，范围 100-4000 像素
- **height** (number, 默认 600): 图表高度，范围 100-4000 像素
- **concurrent_rendering** (number, 默认 1): 并发渲染的 worker 数量，范围 1-4
- **mergeEchartsOptions** (string, JSON 格式): 与每个图表配置合并的额外 ECharts 选项
- **image_type** (select, 默认 "svg"): 输出图片格式（当前仅支持 SVG）

### 2.3 输出格式

#### 2.3.1 文本输出
- 更新后的 Markdown 文本，其中 ````echarts` 代码块被替换为 `![]({image_url})` 格式

#### 2.3.2 图片输出
- SVG 格式的图片文件（blob 消息）
- Base64 编码的 data URL（嵌入在文本中）

#### 2.3.3 摘要信息
- 处理状态（成功/失败）
- 处理的代码块总数
- 成功/失败数量
- 使用的并发数
- 系统信息（执行器类型、架构等）

## 3. 性能要求

### 3.1 响应时间
- 单个简单图表（<100 数据点）：< 2 秒
- 单个复杂图表（1000+ 数据点）：< 10 秒
- 批量处理（3 个图表）：< 15 秒

### 3.2 并发能力
- 支持 1-4 个 worker 并发渲染
- 根据图表复杂度自动选择最优并发数

## 4. 兼容性要求

### 4.1 系统架构
- **架构支持**：Linux amd64、Linux arm64
- **打包限制**：由于 Dify 插件包（.difypkg）大小限制为 50MB，实际发布的插件包中仅包含 **Linux amd64** 二进制文件
- Linux amd64 是生产环境的标准架构
- Linux arm64 支持仅在开发/测试环境中可用（通过 `INCLUDE_ARM64=true` 构建）

### 4.2 运行时环境
- Python 3.12
- 内存限制：256MB

### 4.3 ECharts 兼容性
- 支持标准 ECharts 配置格式
- 支持 ECharts 5.x 版本

## 5. 错误处理

### 5.1 输入验证
- JSON 格式错误：返回明确的错误信息，标识出错的代码块
- 参数范围错误：自动修正到有效范围内
- 缺少必需参数：返回错误提示

### 5.2 渲染错误
- 配置错误：返回 ECharts 渲染错误信息
- 执行器错误：返回执行器相关错误，提供降级方案

### 5.3 部分失败处理
- 多个代码块中部分失败时，成功部分正常返回
- 失败部分保持原代码块不变
- 摘要信息中明确标注成功/失败数量

## 6. 用户体验

### 6.1 易用性
- 参数提供合理的默认值
- 错误信息清晰易懂

### 6.2 可配置性
- 图片尺寸可自定义
- 并发数可根据场景调整
- 支持配置合并以满足不同需求

### 6.3 反馈信息
- 提供详细的处理摘要
- 包含系统信息便于调试
- 明确标识成功和失败的操作
